<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="img/school.png" type="image/png">
    <title>Публикация</title>
    <link rel="stylesheet" href="styles/style.css">
    <link rel="stylesheet" href="styles/post.css">
</head>

<body>

    <div id="app">
        <div class="panel" style="background-color: #4682b4; padding: 10px; margin-bottom: 20px;">
            <button @click="go_back()">Назад</button>
            <button @click="login()" class="login_btn">Войти</button>
        </div>

        <div class="post">
            <p>{{ data.username }}</p>
            <p>{{ data.date }}</p>
            <p>{{ data.text }}</p>
            <p>Chat ID: {{ data.chat_id }}</p>
        </div>

        <div class="input_field">
            <input v-model="answerText" placeholder="Введите ответ на вопрос">
            <button class="send_btn" @click="add_answer()">Отправить</button>
        </div>
        <div v-for="reply in replies" class="replies">
            <p>{{ reply.username }}</p>
            <p>{{ reply.date }}</p>
            <p>{{ reply.text }}</p>
            <!-- <img src="{{reply.url}}"> -->
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    rotation_date: 0,
                    data: [],
                    replies: [],
                    desc_option: 'false',
                    answerText: '',
                    post_id: 0,
                    token: '',
                    headers: {},
                    username: ''
                };
            },
            mounted() {
                this.token = this.getCookie('token')
                this.username = this.getCookie('username')
                if (this.token != '') {
                    this.button_text = 'Выйти'
                }
                this.headers = {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + this.token
                };
                this.parse_post_id()
            },
            methods: {
                getCookie(name) {
                    var nameEQ = name + "=";
                    var ca = document.cookie.split(';');
                    for (var i = 0; i < ca.length; i++) {
                        var c = ca[i];
                        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
                    }
                    return null;
                },
                request_get(method, args = [''], headers = {}) {
                    return new Promise((resolve, reject) => {
                        const options = args.join('&');
                        const xhr = new XMLHttpRequest();
                        const url = 'http://45.146.164.205/api/' + method + '?' + options;
                        xhr.open('GET', url, true);
                        Object.keys(headers).forEach(key => {
                            xhr.setRequestHeader(key, headers[key]);
                        });
                        xhr.onreadystatechange = () => {
                            if (xhr.readyState === 4) {
                                if (xhr.status === 200) {
                                    const responseData = JSON.parse(xhr.responseText);
                                    resolve(responseData);
                                } else {
                                    reject('Request failed with status: ' + xhr.status);
                                }
                            }
                        };
                        xhr.send();
                    });
                },
                request_post(method, data = {}, headers = {}) {
                    return new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        const url = 'http://45.146.164.205/api/' + method;
                        xhr.open('POST', url, true);
                        Object.keys(headers).forEach(key => {
                            xhr.setRequestHeader(key, headers[key]);
                        });
                        xhr.onreadystatechange = () => {
                            if (xhr.readyState === 4) {
                                if (xhr.status === 200) {
                                    const responseData = JSON.parse(xhr.responseText);
                                    resolve(responseData);
                                } else {
                                    reject('Request failed with status: ' + xhr.status);
                                }
                            }
                        };
                        xhr.send(JSON.stringify(data));
                    });
                },
                add_answer(chat_id, post_id) {
                    postData = {
                        "message_text": this.answerText,
                        "chat_id": 123,
                        "username": this.username,
                        "post_id": this.post_id
                    };

                    this.request_post('new_reply/', postData, this.headers)
                        .then(() => {
                            window.location.reload();
                        })
                        .catch(error => {
                            console.error('Ошибка при отправке ответа:', error);
                        });
                },
                get_post(id) {
                    this.request_get(`get_message/${id}`, [], this.headers).then(
                        data => {
                            this.data = data;
                        })
                },
                get_replies(id) {
                    this.request_get(`get_replies/${id}`, [], this.headers).then(
                        data => {
                            this.replies = data;
                        })
                },
                go_back() {
                    window.location.href = "/";
                },
                login() {
                    window.location.href = "login"
                },
                parse_post_id() {
                    urlParams = new URLSearchParams(window.location.search);
                    postId = urlParams.get('post_id');
                    if (postId) {
                        this.post_id = postId
                        this.get_post(postId)
                        this.get_replies(postId)
                    } else {
                        console.error("Post ID not found in the URL.");
                    }
                }
            }
        });
    </script>

</body>

</html>