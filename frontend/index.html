<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="img/school.png" type="image/png">
  <title>Students Forum</title>
  <link rel="stylesheet" href="styles/style.css">
  <link rel="stylesheet" href="styles/index.css">
</head>

<body>

  <div id="app">
    <div class="panel" style="background-color: #4682b4; padding: 10px; margin-bottom: 20px;">
      <button @click="sortByDate()">
        <img src="img/arrow.png" alt="Arrow" width="20" style="vertical-align: middle;"
          :style="{ transform: 'rotate(' + rotation_date + 'deg)' }">
        Дата
      </button>

      <div class="dropdown">
        <button class="dropbtn">Выберите чат</button>
        <div class="dropdown-content">
          <a v-for="chat in chats" @click="selectChat(chat.chat_id)">{{ chat.chat_username }}
            <img v-if="selected_chats.includes(chat.chat_id)" src="img/checkmark.png" alt="Checkmark" width="20">
          </a>
        </div>
      </div>

      <input type="date" id="date1" name="date1" v-model="end_date" @change="fetchDataByDate" />
      <input type="date" id="date2" name="date2" v-model="start_date" @change="fetchDataByDate" />


      <button @click=" login()" class="login_btn">{{ button_text }}</button>
      <button v-if="adm_options==true" @click="go_to_users()" class="manage_btn">Управление пользователями</button>
    </div>

    <div v-for="item in data" class="posts">
      <button v-if="adm_options==true" @click="delete_post(item.id)" class="del_btn">Удалить</button>
      <p v-if="item.name != null">{{ item.name }}</p>
      <p v-if="item.last_name != null">{{ item.last_name }}</p>
      <p v-if="item.name == null">{{ item.username }}</p>
      <p>{{ item.date }}</p>
      <p style="font-size: 18px;">{{ item.text }}</p>
      <p>Чат: {{ item.chatname }}</p>
      <p v-if="item.is_admin_answer" style="color: red;">Админ дал ответ</p>
      <button @click="select_post(item.id)">Ответить</button>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script>
    new Vue({
      el: '#app',
      data() {
        return {
          button_text: 'Выйти',
          rotation_date: 0,
          selected_chats: [],
          chats: [],
          data: [],
          desc_option: 'false',
          token: '',
          headers: {},
          admin_token: '',
          adm_options: false,
          start_date: '',
          end_date: '',
          ip: 'http://31.129.96.68/api/'
        };
      },
      mounted() {
        this.token = this.getCookie('token')
        this.admin_token = this.getCookie('admin_token')
        if (this.token == '') {
          this.button_text = 'Войти'
        }
        if (this.admin_token != '') {
          this.adm_options = true
        }

        this.headers = {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + this.token
        };
        this.get_chats()
        this.sortByDate()
      },
      methods: {
        delete_post(post_id) {
          if (confirm('Вы уверены, что хотите удалить этот пост?')) {
            this.request_delete('delete_message/' + post_id, this.headers)
              .then(response => {
                alert('Пост успешно удален.');
                this.fetchData(this.selected_chats, this.desc_option);
              })
              .catch(error => {
                console.error('Ошибка при удалении поста:', error);
                alert('Произошла ошибка при удалении поста.');
              });
          }
        },
        request_delete(url, headers = {}) {
          return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('DELETE', this.ip + url, true);
            Object.keys(headers).forEach(key => {
              xhr.setRequestHeader(key, headers[key]);
            });
            xhr.onreadystatechange = () => {
              if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                  resolve(xhr.responseText);
                } else {
                  reject('Request failed with status: ' + xhr.status);
                }
              }
            };
            xhr.send();
          });
        },
        getCookie(name) {
          var nameEQ = name + "=";
          var ca = document.cookie.split(';');
          for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
          }
          return "";
        },
        request_get(method, args = [''], headers = {}) {
          return new Promise((resolve, reject) => {
            const options = args.join('&');
            const xhr = new XMLHttpRequest();
            const url = this.ip + method + '?' + options;
            xhr.open('GET', url, true);
            Object.keys(headers).forEach(key => {
              xhr.setRequestHeader(key, headers[key]);
            });
            xhr.onreadystatechange = () => {
              if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                  const responseData = JSON.parse(xhr.responseText);
                  resolve(responseData);
                } else {
                  reject('Request failed with status: ' + xhr.status);
                }
              }
            };
            xhr.send();
          });
        },
        fetchData(chats = this.chats, desc_option = this.desc_option) {
          if (chats.length > 0) {
            chats_param = `chat_id=${chats.join('&chat_id=')}`
          } else { chats_param = '' }
          this.request_get('get_messages', [`des=${desc_option}`, chats_param], this.headers)
            .then(data => {
              this.fetchDataByDate()
            })
        },
        login() {
          if (this.token == '') {
            window.location.href = "/login"
          } else {
            this.clearAllCookies()
            window.location.href = "/login"
          }
        },
        get_chats() {
          this.request_get('get_chats', [], this.headers)
            .then(data => {
              // Фильтрация уникальных чатов
              const uniqueChats = data.filter((chat, index, self) =>
                index === self.findIndex(c => c.chat_id === chat.chat_id)
              );
              this.chats = uniqueChats;
            });
        },

        sortByDate() {
          if (this.desc_option == 'true') {
            this.desc_option = 'false'
            this.rotation_date = 180
          } else {
            this.desc_option = 'true'
            this.rotation_date = 0
          }
          this.fetchData(this.selected_chats, this.desc_option);
        },
        fetchDataByDate() {
          // Формируем строку для запроса на сервер
          const startDateParam = `date_to=${this.start_date}`;
          const endDateParam = `date_from=${this.end_date}`;
          const chatsParam = this.selected_chats.length > 0 ? `&chat_id=${this.selected_chats.join('&chat_id=')}` : '';

          // Выполняем запрос на сервер
          this.request_get('get_messages', [startDateParam, endDateParam, chatsParam, `des=${this.desc_option}`], this.headers)
            .then(data => {
              this.data = data;
            })
            .catch(error => {
              console.error('Ошибка при получении данных:', error);
              alert('Произошла ошибка при загрузке данных.');
            });

        },
        selectChat(chat) {
          if (!this.selected_chats.includes(chat)) {
            this.selected_chats.push(chat);
          } else {
            this.selected_chats = this.selected_chats.filter(selectedChat => selectedChat !== chat);
          }
          this.fetchData(this.selected_chats, this.desc_option);
        },
        select_post(post_id) {
          window.location.href = `post?post_id=${post_id}`;
        },
        go_to_users() {
          window.location.href = "users"
        },
        clearAllCookies() {
          var cookies = document.cookie.split(";");

          for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i];
            var eqPos = cookie.indexOf("=");
            var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
            document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;";
          }
        }
      }
    });
  </script>

</body>

</html>